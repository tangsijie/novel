!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).canvas={})}(this,(function(t){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */var e,i=function(t,e){return i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])},i(t,e)};function n(t){var e,i,n=document.createElement("div");return n.innerHTML=t.trim(),null!==(i=null===(e=n.firstChild)||void 0===e?void 0:e.textContent)&&void 0!==i?i:""}!function(t){t[t.Qidian=1]="Qidian"}(e||(e={}));var r=function(t,i){return i==e.Qidian?function(t){var e=t.split("</p>"),i="",r="",o=[];return e.forEach((function(t){for(var e=t.split("<p>"),h=0;h<e.length;h++){var a=e[h];a.indexOf("block")>=0?i=n(a):a.indexOf("32px")>=0?r=n(a):a.length>0&&" "!=a&&-1==a.indexOf("<span")&&o.push(a)}})),{content:o.join("\n"),fockMark:i,mark:r}}(t):{content:"",fockMark:"",mark:""}},o=function(t,e){this.start=t,this.end=e},h=function(){function t(t,e,i){this.lineX=0,this.lineY=0,this.width=0,this.height=0,this.element=i,this.lineX=t,this.lineY=e}return t.prototype.resetStyles=function(){this.element.style.display="block",this.element.style.position="absolute",this.element.style.transform="translate("+this.lineX+"px, "+this.lineY+"px)",this.element.style.lineHeight="0"},t}(),a=function(){function t(t,e,i,n,r,o){this.isFirst=!1,this.isLast=!1,this.text="",this.isFirst=t,this.isLast=e,this.text=i,this.tailDecos=n,this.paragraphIndex=r,this.range=o}return Object.defineProperty(t.prototype,"isEmptyLine",{get:function(){return null==this.paragraphIndex},enumerable:!1,configurable:!0}),t}(),s=function(){function t(t,e){this.top=0,this.watermark="",this.headInstruct=null,this.tailInstruct=null,this._lineSegments=t,this.watermark=e}return Object.defineProperty(t.prototype,"lineSegments",{get:function(){return this._lineSegments},enumerable:!1,configurable:!0}),t}(),l=function(t,e,i){return t.substring(e,Math.min(i,t.length))},p=function(){for(var t,e=[],i=0;i<256;i++){t=i;for(var n=0;n<8;n++)t=1&t?3988161312^t>>>1:t>>>1;e[i]=t}return e}(),c=function(t){for(var e=-1,i=0;i<t.length;i++)e=e>>>8^p[255&(e^t.charCodeAt(i))];return(-1^e)>>>0},u=function(t){return t.split("").sort((function(){return.5-Math.random()})).join("")},f=function(t,e,i){for(var n=[],r=[],o=0;o<i.length;o++){var a=i[o],s=a.elementGenerator(),l=new h(e,0,s);l.height=a.height,l.width=a.width,e+a.width<=t||(e=0,r.push(n),n=[],l.lineX=e),n.push(l),e+=a.width}return n.length>0&&r.push(n),r},g=function(){function t(t,e){var i=this;if(this.text="",this.debug=!1,this.paragraphLength=0,this.panelSegments=[],this.lineSegments=[],this.totalHeight=0,this.watermark="",this._lineHeight=0,this._fontSize=20,this._fontName="Song",this._textColor="#000",null==e.width)throw"No size given";this._parent=t,this.options=e,this.container=document.createElement("div"),this.container.style.width=this.options.width+"px",this.container.style.columnWidth=this.options.width+"px",this.container.style.columnGap="0px",this.container.style.overflow="hidden",this.container.style.lineHeight="0",this._parent.appendChild(this.container),this._calculationCanvas=document.createElement("canvas");var n=this._calculationCanvas.getContext("2d");if(!n)throw"No ctx";this._calculationCtx=n,this._tailDecorator=e.paragraphTailDecorator;for(var r=["resize","visibilitychange"],o=0;o<r.length;o++){var h=r[o];window.addEventListener(h,(function(t){document.hidden||i.resetAll()}))}}return t.prototype.panels=function(){return[]},t.prototype.updateTextStyle=function(t,e,i,n){this._textColor=t,this._fontSize=i,this._fontName=e,this._lineHeight=n;for(var r=this.panels(),o=0;o<r.length;o++){var h=r[o];h.font=this.font,h.fontSize=this.fontSize,h.textColor=this._textColor,h.lineHeight=this._lineHeight}this.resetAll()},t.prototype.highlightParagraphs=function(t){for(var e=this.panels(),i=0;i<e.length;i++){e[i].highlightParagraphIndexes=t}},t.prototype.changeWidth=function(t){this.options.width=t,this.container.style.width=this.options.width+"px",this.container.style.columnWidth=this.options.width+"px",this.resetAll()},t.prototype.showWatermark=function(t,e){this.watermark=t||"",this.resetAll()},t.prototype.display=function(t,e,i){void 0===i&&(i=!1);var n=r(t,e);this.text=n.content;var o=t.split("\n");this.paragraphLength=o.length,this.resetAll(),i&&this.showWatermark(n.mark,0)},Object.defineProperty(t.prototype,"parent",{get:function(){return this._parent},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"fontSize",{get:function(){return this._fontSize},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"fontName",{get:function(){return this._fontName},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"font",{get:function(){return this._fontSize+'px "'+this._fontName+'", serif'},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"lineHeight",{get:function(){return this._lineHeight},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"textColor",{get:function(){return this._textColor},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"highlightColor",{set:function(t){for(var e=this.panels(),i=0;i<e.length;i++){e[i].highlightColor=t}},enumerable:!1,configurable:!0}),t.prototype.resetAll=function(){this.layout()},t.prototype.layout=function(){var t=this;this._calculationCanvas.width=this.options.width,this._calculationCanvas.height=1e3;var e=[],i=0;!function(t,e,i,n,r,h,a){var s=["；","，","、","。","“","？","”","：","！"],p=e.split("\n");t.font=n,c(t.measureText.toString());for(var g=t.measureText("的").width,d=i/g,m=0;m<p.length;m++){for(var v=p[m],y=Math.ceil(v.length/d),_=0,x=0;x<y;x++){var w=_,b=d,S=0,C=l(v,w,_=w+b+S);c(t.measureText.toString());var P=t.measureText(u(C));for(S=Math.floor((i-P.width)/g),C=l(v,w,_=w+b+S),P=t.measureText(u(C));P.width<i;){var M=l(v,w,_+1);if(!(M.length>C.length))break;if(!((P=t.measureText(u(C))).width<i||s.indexOf(M.charAt(M.length-1))>-1))break;C=M,_+=1}if(0==C.length&&w>0);else if(h){_=Math.min(_,v.length);var H=l(v,_,_+1);s.indexOf(H)>=0&&(_-=1);var O=_==v.length,k=[];if(O&&r){var D=t.measureText(C).width,I=r(m,p.length);k=f(i,D,I)}if(h(0==x,O,C,k[0],new o(w,Math.min(_,v.length)),m),k.length>1)for(var T=1;T<k.length;T++)h(0==x,O,"",k[T],new o(_,_),m);if(O)break}}a&&a(m,v,p.length)}}(this._calculationCtx,this.text,this.options.width,this.font,this._tailDecorator,(function(n,r,o,h,s,l){e.push(new a(n,r,o,h,l,s)),i+=t.lineHeight}),(function(n,r,o){n!=o-1&&e.push(new a(!1,!1,"",null,null,null)),i+=t.lineHeight})),this.totalHeight=Math.ceil(i),this.lineSegments=e},t}();var d=function(){function t(t,e,i){void 0===i&&(i=!0);var n=this;this.background="rgba(255,255,255,0)",this._panelSegment=null,this._textColor="#000",this._font="",this._fontSize=0,this._lineHeight=0,this._top=0,this._left=0,this._width=0,this._height=0,this._dirty=!1,this.currentTailDecos=[],this.insertedArticleElements=[],this._highlightParagraphIndexes=[],this._highlightColor=null,this.container=document.createElement("div"),this.container.style.lineHeight="0",i||(this.container.style.position="absolute"),this.tailDecosContainer=document.createElement("div"),this.tailDecosContainer.style.lineHeight="1",this.canvas=document.createElement("canvas"),this.canvas.style.width="100%",this.canvas.style.height="100%",this.container.appendChild(this.canvas),this.container.appendChild(this.tailDecosContainer);var r=this.canvas.getContext("2d");if(!r)throw"Wrong state";if(this.ctx=r,t.appendChild(this.container),e)for(var o=function(t){var i=e[t];h.container.addEventListener(i.event,(function(t){var e,r=t;if(r){var o=Math.floor(r.offsetY/n._lineHeight),h=null===(e=n._panelSegment)||void 0===e?void 0:e.lineSegments[o];h&&!h.isEmptyLine&&i.handler(h.paragraphIndex,i.event,t)}}))},h=this,a=0;a<e.length;a++)o(a)}return Object.defineProperty(t.prototype,"width",{get:function(){return this._width},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return this._height},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"top",{get:function(){return this._top},set:function(t){this._top=t,this.container.style.transform="translate(0px,"+this._top+"px)"},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"left",{get:function(){return this._top},set:function(t){this._left=t,this.container.style.transform="translate("+this._left+"px, 0px)"},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"panelSegment",{get:function(){return this._panelSegment},set:function(t){this._panelSegment=t,this.resetArticleDecorators(),null==t||0==t.lineSegments.length&&null==t.headInstruct&&null==t.tailInstruct?this.container.style.display="none":this.container.style.display="block",this.insertTailDecos(),this._dirty=!0},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"textColor",{get:function(){return this._textColor},set:function(t){var e=t!=this._textColor;this._textColor=t,this._dirty=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"font",{get:function(){return this._font},set:function(t){var e=t!=this._font;this._font=t,this._dirty=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"fontSize",{get:function(){return this._fontSize},set:function(t){var e=t!=this._fontSize;this._fontSize=t,this._dirty=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"lineHeight",{get:function(){return this._lineHeight},set:function(t){var e=t!=this._lineHeight;this._lineHeight=t,this._dirty=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"highlightParagraphIndexes",{get:function(){return this._highlightParagraphIndexes},set:function(t){this._highlightParagraphIndexes=t,this.repaint()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"highlightColor",{set:function(t){this._highlightColor=t,this.repaint()},enumerable:!1,configurable:!0}),t.prototype.repaint=function(){this._dirty=!0,this.draw()},t.prototype.resetArticleDecorators=function(){var t,e;if(this.insertedArticleElements.forEach((function(t){return t.remove()})),null===(t=this.panelSegment)||void 0===t?void 0:t.headInstruct){var i=this.panelSegment.headInstruct.elementGenerator();this.insertedArticleElements.push(i),this.container.insertBefore(i,this.canvas)}if(null===(e=this.panelSegment)||void 0===e?void 0:e.tailInstruct){i=this.panelSegment.tailInstruct.elementGenerator();this.insertedArticleElements.push(i),this.container.appendChild(i)}},t.prototype.insertTailDecos=function(){for(var t,e,i=0;i<this.currentTailDecos.length;i++){(a=this.currentTailDecos[i]).element.remove?a.element.remove():null===(t=a.element.parentElement)||void 0===t||t.removeChild(a.element)}this.currentTailDecos=[];var n=0,r=null===(e=this.panelSegment)||void 0===e?void 0:e.lineSegments;if(r)for(i=0;i<r.length;i++){var o=r[i].tailDecos;if(o){for(var h=0;h<o.length;h++){var a=o[h];this.currentTailDecos.push(a),a.lineY=n,a.resetStyles(),this.tailDecosContainer.appendChild(a.element)}n+=this.lineHeight}else n+=this.lineHeight}},t.prototype.drawHighlight=function(t,e,i){var n=this.ctx;if(t.text.length>0&&null!=t.paragraphIndex&&this.highlightParagraphIndexes.indexOf(t.paragraphIndex)>-1){var r=n.measureText(u(t.text)),o=0,h=0;t.isFirst&&(o=h=n.measureText("　　").width),this._highlightColor?n.fillStyle=this._highlightColor(t.paragraphIndex):n.fillStyle="#ff3e005f";var a=r.actualBoundingBoxAscent||parseInt(this._fontSize+""),s=r.actualBoundingBoxDescent||0;n.fillRect(o,i?e:e-a,r.width-h,a+s)}},t.prototype.draw=function(t){var e,i,n,r,o,h;if(void 0===t&&(t=!1),this._dirty||t){this.resetContainerSize(),this._dirty=!1;var s=this.ctx,l=window.devicePixelRatio||1;s.scale(l,l),s.fillStyle=this.background,s.fillRect(0,0,this._width,this._height),s.font=this.font;for(var p=0,c=!1,u=null!==(i=null===(e=this.panelSegment)||void 0===e?void 0:e.lineSegments)&&void 0!==i?i:[],f=null!==(r=null===(n=this.panelSegment)||void 0===n?void 0:n.watermark)&&void 0!==r?r:"",g=s.measureText(f).width,d=u.length,m=[],v=0;v<u.length;v++){var y=u[v];if(this.drawHighlight(y,p,0==v),!c&&y.text.length>0){var _=s.measureText(y.text);_.actualBoundingBoxAscent?p+=_.actualBoundingBoxAscent:p+=parseInt(this._fontSize+""),c=!0}if(y.text.length>0)m.push({line:y,top:p,left:0,watermark:!1});else if(null===(o=this.panelSegment)||void 0===o?void 0:o.watermark){var x=null===(h=this.panelSegment)||void 0===h?void 0:h.watermark,w=v%5==0;x.length>0&&(d+g<this.width&&w&&(m.push({line:new a(!1,!1,x,null,null,null),top:p,left:d,watermark:!0}),d+=g),d>this.width&&(d=0))}p+=this.lineHeight}for(var b=function(t){for(var e,i,n=t.length;0!=n;)i=Math.floor(Math.random()*n),n--,e=[t[i],t[n]],t[n]=e[0],t[i]=e[1];return t}(m),S=0;S<b.length;S++){var C=b[S];C.watermark?s.fillStyle="#0000003a":s.fillStyle=this.textColor,s.globalCompositeOperation="source-over",s.fillText(C.line.text,C.left,C.top,this._width)}}},t.prototype.addAntiOCRMark3=function(t,e){for(var i=0;i<100;i++)t.beginPath(),t.arc(this.width*Math.random(),e*Math.random(),10*Math.random(),0,2*Math.PI),t.fillStyle="#000000cf",t.globalCompositeOperation="xor",t.fill()},t.prototype.addAntiOCRMark2=function(t,e){var i=e.measureText("的").width,n="一二三四五六七八九十心区人仁认刃中女以为位上下左右层的又火水土风主从不了你尼哈口匹正反什么市区个百千万亿".split("");e.fillStyle="rgba(0,0,0,"+(.2*Math.random()+.1)+")";for(var r="米众乜".split(""),o=0;o<t.line.text.length;o++){var h=t.line.text[o];if(n.indexOf(h)>=0){var a=Math.floor(100*Math.random())%r.length;e.measureText(t.line.text.slice(0,o+1)).width;e.fillText(r[a],i*o,t.top,this._width)}}},t.prototype.addAntiOCRMark=function(t,e){for(var i,n=e.measureText("的").width,r=0;r<t.line.text.length;r++){var o=t.line.text[r];"　"!=o&&!t.watermark&&("string"!=typeof(i=o)||isNaN(i)||isNaN(parseFloat(i)))&&(e.beginPath(),e.moveTo(t.left+n*r+Math.random()*n/2,t.top-10*Math.random()),e.lineTo(t.left+n*r+Math.random()*n/2,t.top-10*Math.random()),e.closePath(),e.setLineDash([1,0,1]),e.lineWidth=4*Math.random(),e.strokeStyle="rgba(255,255,255, 1)",e.globalCompositeOperation="destination-out",e.stroke(),e.beginPath(),e.fillStyle="rgba(0,0,0,"+(Math.random()+.2)+")",e.arc(t.left+n*r+Math.random()*n/2,t.top-10*Math.random(),2*Math.random(),0,2*Math.PI),e.arc(t.left+n*r+Math.random()*n/2,t.top-10*Math.random(),2*Math.random(),0,2*Math.PI),e.arc(t.left+n*r+Math.random()*n/2,t.top-10*Math.random(),1*Math.random(),0,2*Math.PI),e.globalCompositeOperation="destination-out",e.fill())}},t.prototype.updateSize=function(t,e){this._width=t,this._height=e;var i=window.devicePixelRatio||1;this.canvas.width=t*i,this.canvas.height=e*i,this.canvas.style.width=t+"px",this.canvas.style.height=e+"px",this.container.style.width=t+"px",this.container.style.height=e+"px",this.tailDecosContainer.style.width=t+"px",this.tailDecosContainer.style.height=e+"px",this.tailDecosContainer.style.transform="translate(0,"+-e+"px)",this._dirty=!0},t.prototype.drawTestColor=function(t){var e=this.canvas.getContext("2d");e&&(e.fillStyle=t,e.fillRect(0,0,this.canvas.width,this.canvas.height))},t.prototype.resetContainerSize=function(){var t,e,i,n,r,o,h;if(0!=(null===(t=this.panelSegment)||void 0===t?void 0:t.lineSegments.length)){var a=window.devicePixelRatio||1,s=null!==(i=null===(e=this.panelSegment)||void 0===e?void 0:e.lineSegments)&&void 0!==i?i:[],l=this.lineHeight*s.length,p=l+((null===(r=null===(n=this.panelSegment)||void 0===n?void 0:n.headInstruct)||void 0===r?void 0:r.height)||0)+((null===(h=null===(o=this.panelSegment)||void 0===o?void 0:o.tailInstruct)||void 0===h?void 0:h.height)||0);p<this._height?(this.container.style.height=p+"px",this.canvas.height=l*a,this.canvas.style.height=l+"px",this.tailDecosContainer.style.height=l+"px"):(this.container.style.height=this._height+"px",this.canvas.height=l*a,this.canvas.style.height=l+"px",this.tailDecosContainer.style.height=l+"px"),this.tailDecosContainer.style.transform="translate(0,"+-l+"px)"}},t}(),m=function(t){function e(e,i){var n=t.call(this,e,i)||this;return n.insertedArticleElements=[],n._panel1=new d(n.container,i.paragraphHandlers,!1),n._panel2=new d(n.container,i.paragraphHandlers,!1),document.addEventListener("scroll",(function(t){n.scrollRefresh()})),n}return function(t,e){function n(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}(e,t),e.prototype.panels=function(){return[this._panel1,this._panel2]},e.prototype.highlightParagraphs=function(t){this._panel1.highlightParagraphIndexes=t,this._panel2.highlightParagraphIndexes=t},e.prototype.resetAll=function(){t.prototype.resetAll.call(this),this.resetPanelSegments(),this.resetArticleDecorators(),this.scrollRefresh()},e.prototype.resetArticleDecorators=function(){if(this.insertedArticleElements.forEach((function(t){return t.remove()})),this.options.articleDecorator&&this.paragraphLength>0){var t=this.options.articleDecorator(-1,this.paragraphLength);if(t.length>0){var e=t[0].elementGenerator();this.insertedArticleElements.push(e),this.parent.insertBefore(e,this.container)}if((t=this.options.articleDecorator(this.paragraphLength,this.paragraphLength)).length>0){e=t[0].elementGenerator();this.insertedArticleElements.push(e),this.parent.appendChild(e)}}},e.prototype.scrollRefresh=function(){var t=function(t){for(var e=0,i=t;null!=i.offsetParent;)e+=i.offsetTop,i=i.offsetParent;return e}(this.container),e=window.scrollY;e||(e=window.pageYOffset);var i=Math.max(e-t,0),n=Math.floor(i/this._panel1.height),r=2*Math.ceil(n/2),o=2*Math.floor(n/2)+1,h=r*this._panel1.height,a=o*this._panel1.height;if(!(h>=this.totalHeight&&a>=this.totalHeight)){this._panel1.top=h;var s=this.panelSegments[r];if(this._panel1.panelSegment=s,this._panel2.top=o*this._panel1.height,o<this.panelSegments.length){var l=this.panelSegments[o];this._panel2.panelSegment=l}else this._panel2.panelSegment=null;this._panel1.draw(),this._panel2.draw()}},e.prototype.resetPanelSegments=function(){var t=[],e=this._totalHeight(),i=Math.floor(e/this.lineHeight);this._resetPanelSize(i*this.lineHeight);for(var n=[],r=0;r<this.lineSegments.length;r++)n.length==i&&(t.push(new s(n,this.watermark)),n=[]),n.push(this.lineSegments[r]);n.length>0&&t.push(new s(n,this.watermark)),this.panelSegments=t},e.prototype._totalHeight=function(){var t=window.innerHeight;return this.totalHeight<window.innerHeight&&(t=this.totalHeight),t},e.prototype._resetPanelSize=function(t){this._panel1.updateSize(this.options.width,t),this._panel2.updateSize(this.options.width,t),this._panel2.top=this._panel1.height,this.container.style.height=this.totalHeight+"px"},e}(g);t.ScrollCanvas=m,Object.defineProperty(t,"__esModule",{value:!0})}));
